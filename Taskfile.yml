# Copyright 2026 Kamesh Sampath
# Generated with Cortex Code
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#! /usr/bin/env task
# https://taskfile.dev
version: "3"

# Always run from the project directory (enables running via symlink from anywhere)
dir: "{{.TASKFILE_DIR}}"

dotenv: [".env"]

vars:
  # Use uv run to automatically use the project's venv from any directory
  PYTHON: uv run --project {{.TASKFILE_DIR}}
  # CLI scripts
  PAT_CLI: "{{.PYTHON}} {{.TASKFILE_DIR}}/pat.py"
  EXTVOLUME_CLI: "{{.PYTHON}} {{.TASKFILE_DIR}}/extvolume.py"
  NETWORK_CLI: "{{.PYTHON}} {{.TASKFILE_DIR}}/network.py"
  # Default bucket name for demos
  BUCKET: iceberg-demo
  # AWS region
  AWS_REGION: '{{.AWS_REGION | default "us-west-2"}}'

env:
  # Pass through important env vars
  AWS_REGION: "{{.AWS_REGION}}"
  SNOWFLAKE_DEFAULT_CONNECTION_NAME: "{{.SNOWFLAKE_DEFAULT_CONNECTION_NAME}}"
  SNOWFLAKE_ROLE: "{{.SNOWFLAKE_ROLE}}"
  SNOWFLAKE_DATABASE: "{{.SNOWFLAKE_DATABASE}}"

tasks:
  # ===========================================================================
  # Setup Tasks
  # ===========================================================================

  default:
    desc: Show available tasks
    cmds:
      - task --list-all

  setup:
    desc: Setup development environment with uv and install global command
    cmds:
      - uv venv
      - uv sync
      - |
        # Create symlink in ~/.local/bin if it doesn't exist
        mkdir -p ~/.local/bin
        if [ ! -L ~/.local/bin/snow-utils ]; then
          ln -sf "{{.TASKFILE_DIR}}/snow-utils" ~/.local/bin/snow-utils
          echo "✓ Installed snow-utils to ~/.local/bin/snow-utils"
        else
          echo "✓ snow-utils symlink already exists"
        fi
    sources:
      - pyproject.toml
      - requirements.txt
    generates:
      - .venv/**/*

  install:
    desc: Install dependencies
    cmds:
      - uv sync

  # ===========================================================================
  # PAT Management Tasks
  # ===========================================================================

  pat:create:
    desc: Create/rotate PAT for service user
    summary: |
      Creates or rotates a Programmatic Access Token (PAT) for the service user.

      Environment variables (can be set in .env):
        SA_USER: Service account username
        SA_ROLE: Role restriction for the PAT (the role the SA will use)
        SA_ADMIN_ROLE: Admin role for creating policies (default: same as SA_ROLE)
        SNOW_UTILS_DB: Database for PAT objects
        DOT_ENV_FILE: Path to .env file to update (default: .env in current directory)

      Example:
        task pat:create SA_USER=my_service_user SA_ROLE=demo_role SA_ADMIN_ROLE=sysadmin SNOW_UTILS_DB=my_db
        task pat:create DOT_ENV_FILE=/path/to/project/.env  # update .env in specific location
        task pat:create  # uses env vars from .env
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.PAT_CLI}} create {{.CLI_ARGS}}"
    env:
      SA_USER: "{{.SA_USER}}"
      SA_ROLE: "{{.SA_ROLE}}"
      SA_ADMIN_ROLE: "{{.SA_ADMIN_ROLE}}"
      SNOW_UTILS_DB: "{{.SNOW_UTILS_DB}}"
      DOT_ENV_FILE: "{{.DOT_ENV_FILE}}"
    vars:
      SA_USER: '{{.SA_USER | default ""}}'
      SA_ROLE: '{{.SA_ROLE | default ""}}'
      SA_ADMIN_ROLE: '{{.SA_ADMIN_ROLE | default ""}}'
      SNOW_UTILS_DB: '{{.SNOW_UTILS_DB | default ""}}'
      DOT_ENV_FILE: '{{.DOT_ENV_FILE | default ""}}'

  pat:no-rotate:
    desc: Create PAT without rotating existing
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.PAT_CLI}} create --no-rotate {{.CLI_ARGS}}"
    env:
      SA_USER: "{{.SA_USER}}"
      SA_ROLE: "{{.SA_ROLE}}"
      SA_ADMIN_ROLE: "{{.SA_ADMIN_ROLE}}"
      SNOW_UTILS_DB: "{{.SNOW_UTILS_DB}}"
      DOT_ENV_FILE: "{{.DOT_ENV_FILE}}"
    vars:
      SA_USER: '{{.SA_USER | default ""}}'
      SA_ROLE: '{{.SA_ROLE | default ""}}'
      SA_ADMIN_ROLE: '{{.SA_ADMIN_ROLE | default ""}}'
      SNOW_UTILS_DB: '{{.SNOW_UTILS_DB | default ""}}'
      DOT_ENV_FILE: '{{.DOT_ENV_FILE | default ""}}'

  pat:remove:
    desc: Remove PAT and associated objects
    summary: |
      Removes a PAT and associated objects (network policy, auth policy) for a service user.
      Also clears SNOWFLAKE_PASSWORD from .env file.

      Environment variables (can be set in .env):
        SA_USER: Service account username
        SNOW_UTILS_DB: Database where PAT objects are stored
        DOT_ENV_FILE: Path to .env file to clear credentials from

      Options:
        --pat-only: Only remove the PAT, keep policies
        --drop-user: Also drop the service user

      Example:
        task pat:remove SA_USER=my_service_user SNOW_UTILS_DB=my_db
        task pat:remove DOT_ENV_FILE=/path/to/.env  # clear specific .env
        task pat:remove -- --pat-only    # only remove PAT
        task pat:remove -- --drop-user   # also drop the user
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.PAT_CLI}} remove --yes {{.CLI_ARGS}}"
    env:
      SA_USER: "{{.SA_USER}}"
      SNOW_UTILS_DB: "{{.SNOW_UTILS_DB}}"
      DOT_ENV_FILE: "{{.DOT_ENV_FILE}}"
    vars:
      SA_USER: '{{.SA_USER | default ""}}'
      SNOW_UTILS_DB: '{{.SNOW_UTILS_DB | default ""}}'
      DOT_ENV_FILE: '{{.DOT_ENV_FILE | default ""}}'

  # ===========================================================================
  # Network Rule & Policy Tasks
  # ===========================================================================

  networks:create:
    desc: Create a network rule with optional policy
    summary: |
      Creates a Snowflake network rule with optional network policy.

      Supports IPv4 presets (GitHub Actions, Google, local IP) and custom values.

      Environment variables (can be set in .env):
        NW_RULE_NAME: Network rule name
        NW_RULE_DB: Database for network rule
        NW_RULE_SCHEMA: Schema for network rule (default: NETWORKS)

      Options:
        --mode: Rule mode (ingress, egress, internal_stage, postgres_ingress, postgres_egress)
        --type: Value type (ipv4, host_port, private_host_port, awsvpceid)
        --with-local: Include local public IP (default for ipv4)
        --with-gh: Include GitHub Actions IPs
        --with-google: Include Google IPs
        --values: Custom comma-separated values
        --policy: Also create/update a network policy
        --policy-mode: create (default) or alter existing policy

      Example:
        task networks:create NW_RULE_NAME=dev_rule NW_RULE_DB=my_db
        task networks:create NW_RULE_NAME=ci_rule NW_RULE_DB=my_db -- --with-gh
        task networks:create NW_RULE_NAME=api_egress NW_RULE_DB=my_db -- --mode egress --type host_port --values "api.example.com:443"
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.NETWORK_CLI}} create {{.CLI_ARGS}}"
    env:
      NW_RULE_NAME: "{{.NW_RULE_NAME}}"
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_NAME: '{{.NW_RULE_NAME | default ""}}'
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:github:
    desc: Create network rule for GitHub Actions IPs
    summary: |
      Creates an INGRESS IPV4 network rule containing GitHub Actions runner IPs.
      Useful for CI/CD pipelines that need to access Snowflake.

      Example:
        task networks:github NW_RULE_NAME=github_actions NW_RULE_DB=my_db
        task networks:github NW_RULE_NAME=github_actions NW_RULE_DB=my_db -- --policy ci_policy
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.NETWORK_CLI}} github {{.CLI_ARGS}}"
    env:
      NW_RULE_NAME: "{{.NW_RULE_NAME}}"
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_NAME: '{{.NW_RULE_NAME | default ""}}'
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:google:
    desc: Create network rule for Google IPs
    summary: |
      Creates an INGRESS IPV4 network rule containing Google IP ranges.
      Useful for Google Apps Script, Cloud Functions, etc.

      Example:
        task networks:google NW_RULE_NAME=google_ips NW_RULE_DB=my_db
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.NETWORK_CLI}} google {{.CLI_ARGS}}"
    env:
      NW_RULE_NAME: "{{.NW_RULE_NAME}}"
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_NAME: '{{.NW_RULE_NAME | default ""}}'
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:local:
    desc: Create network rule for current IP only
    summary: |
      Creates an INGRESS IPV4 network rule containing only your current public IP.
      Most restrictive option - useful for development.

      Example:
        task networks:local NW_RULE_NAME=dev_local NW_RULE_DB=my_db
    deps:
      - task: snow-utils:check
        vars:
          CLI_ARGS: "--quiet"
    cmds:
      - "{{.NETWORK_CLI}} local {{.CLI_ARGS}}"
    env:
      NW_RULE_NAME: "{{.NW_RULE_NAME}}"
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_NAME: '{{.NW_RULE_NAME | default ""}}'
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:policy:
    desc: Create or alter a network policy
    summary: |
      Creates a new network policy or adds rules to an existing one.

      Example:
        task networks:policy -- --name my_policy --rules "DB.NETWORKS.RULE1,DB.NETWORKS.RULE2"
        task networks:policy -- --name my_policy --rules "DB.NETWORKS.RULE3" --alter
    cmds:
      - "{{.NETWORK_CLI}} policy {{.CLI_ARGS}}"

  networks:list-rules:
    desc: List network rules in a schema
    summary: |
      Lists all network rules in the specified database/schema.

      Example:
        task networks:list-rules NW_RULE_DB=my_db
        task networks:list-rules NW_RULE_DB=my_db NW_RULE_SCHEMA=NETWORKS
    cmds:
      - "{{.NETWORK_CLI}} list-rules {{.CLI_ARGS}}"
    env:
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:list-policies:
    desc: List all network policies
    cmds:
      - "{{.NETWORK_CLI}} list-policies"

  networks:delete-rule:
    desc: Delete a network rule
    summary: |
      Deletes a network rule from Snowflake.

      Example:
        task networks:delete-rule NW_RULE_NAME=old_rule NW_RULE_DB=my_db
    cmds:
      - "{{.NETWORK_CLI}} delete-rule --yes {{.CLI_ARGS}}"
    env:
      NW_RULE_NAME: "{{.NW_RULE_NAME}}"
      NW_RULE_DB: "{{.NW_RULE_DB}}"
      NW_RULE_SCHEMA: "{{.NW_RULE_SCHEMA}}"
    vars:
      NW_RULE_NAME: '{{.NW_RULE_NAME | default ""}}'
      NW_RULE_DB: '{{.NW_RULE_DB | default ""}}'
      NW_RULE_SCHEMA: '{{.NW_RULE_SCHEMA | default "NETWORKS"}}'

  networks:delete-policy:
    desc: Delete a network policy
    summary: |
      Deletes a network policy from Snowflake.
      Optionally unsets from a user first.

      Example:
        task networks:delete-policy -- --name my_policy
        task networks:delete-policy -- --name my_policy --user my_user
    cmds:
      - "{{.NETWORK_CLI}} delete-policy --yes {{.CLI_ARGS}}"

  # ===========================================================================
  # External Volume Tasks
  # ===========================================================================

  extvolume:create:
    desc: Create S3 bucket, IAM role, and Snowflake external volume
    summary: |
      Creates all resources needed for a Snowflake external volume:
        - S3 bucket with versioning
        - IAM policy and role
        - Snowflake external volume
        - Updates IAM trust policy with Snowflake's IAM user

      Resources are prefixed with your username by default.

      Environment variables (can be set in .env):
        BUCKET: S3 bucket base name
        EXTERNAL_VOLUME_NAME: Snowflake external volume name

      Example:
        task extvolume:create BUCKET=my-data
        task extvolume:create BUCKET=my-data -- --no-prefix
    cmds:
      - "{{.EXTVOLUME_CLI}} --region {{.AWS_REGION}} create {{.CLI_ARGS}}"
    env:
      BUCKET: "{{.BUCKET}}"
      EXTERNAL_VOLUME_NAME: "{{.EXTERNAL_VOLUME_NAME}}"
    vars:
      BUCKET: '{{.BUCKET | default ""}}'
      EXTERNAL_VOLUME_NAME: '{{.EXTERNAL_VOLUME_NAME | default ""}}'

  extvolume:delete:
    desc: Delete external volume and AWS resources
    summary: |
      Deletes all resources associated with an external volume:
        - Snowflake external volume
        - IAM role and policy
        - Optionally S3 bucket (use --delete-bucket)

      Environment variables (can be set in .env):
        BUCKET: S3 bucket base name
        EXTERNAL_VOLUME_NAME: Snowflake external volume name

      Example:
        task extvolume:delete BUCKET=my-data
        task extvolume:delete BUCKET=my-data -- --delete-bucket --force
    cmds:
      - "{{.EXTVOLUME_CLI}} --region {{.AWS_REGION}} delete {{.CLI_ARGS}}"
    env:
      BUCKET: "{{.BUCKET}}"
      EXTERNAL_VOLUME_NAME: "{{.EXTERNAL_VOLUME_NAME}}"
    vars:
      BUCKET: '{{.BUCKET | default ""}}'
      EXTERNAL_VOLUME_NAME: '{{.EXTERNAL_VOLUME_NAME | default ""}}'
    prompt: "This will delete AWS and Snowflake resources. Continue?"

  extvolume:verify:
    desc: Verify external volume connectivity
    summary: |
      Verifies that Snowflake can connect to the external volume's S3 storage.

      Environment variables (can be set in .env):
        EXTERNAL_VOLUME_NAME: Snowflake external volume name

      Example:
        task extvolume:verify VOLUME=MY_EXTERNAL_VOLUME
        task extvolume:verify  # uses EXTERNAL_VOLUME_NAME from env
    cmds:
      - "{{.EXTVOLUME_CLI}} verify"
    env:
      EXTERNAL_VOLUME_NAME: "{{.VOLUME}}"
    vars:
      VOLUME: '{{.VOLUME | default ""}}'

  extvolume:describe:
    desc: Describe external volume properties
    summary: |
      Shows external volume properties including:
        - STORAGE_AWS_IAM_USER_ARN
        - STORAGE_AWS_EXTERNAL_ID

      Environment variables (can be set in .env):
        EXTERNAL_VOLUME_NAME: Snowflake external volume name

      Example:
        task extvolume:describe VOLUME=MY_EXTERNAL_VOLUME
        task extvolume:describe  # uses EXTERNAL_VOLUME_NAME from env
    cmds:
      - "{{.EXTVOLUME_CLI}} describe"
    env:
      EXTERNAL_VOLUME_NAME: "{{.VOLUME}}"
    vars:
      VOLUME: '{{.VOLUME | default ""}}'

  extvolume:update-trust:
    desc: Update IAM trust policy from external volume
    summary: |
      Re-syncs the IAM trust policy with Snowflake's IAM user ARN.
      Use this if you've recreated the external volume or need to fix trust issues.

      Environment variables (can be set in .env):
        BUCKET: S3 bucket base name
        EXTERNAL_VOLUME_NAME: Snowflake external volume name

      Example:
        task extvolume:update-trust BUCKET=my-data
        task extvolume:update-trust ROLE=my-role VOLUME=MY_VOLUME
        task extvolume:update-trust  # uses env vars
    cmds:
      - "{{.EXTVOLUME_CLI}} --region {{.AWS_REGION}} update-trust {{.CLI_ARGS}}"
    env:
      BUCKET: "{{.BUCKET}}"
      EXTERNAL_VOLUME_NAME: "{{.VOLUME}}"
    vars:
      BUCKET: '{{.BUCKET | default ""}}'
      VOLUME: '{{.VOLUME | default ""}}'

  # ===========================================================================
  # External Volume Quick Start
  # ===========================================================================

  extvolume:up:
    desc: Quick start - create bucket and external volume with defaults
    summary: |
      One-command setup for Iceberg external volumes. Creates:
        - S3 bucket: {username}-{bucket}
        - IAM role/policy
        - External volume: {USERNAME}_{BUCKET}_EXTERNAL_VOLUME

      Environment variables (can be set in .env):
        BUCKET: S3 bucket base name (default: iceberg-demo)

      Example:
        task extvolume:up
        task extvolume:up BUCKET=my-data
    cmds:
      - task: extvolume:create
    env:
      BUCKET: '{{.BUCKET | default "iceberg-demo"}}'

  extvolume:down:
    desc: Tear down - delete bucket and external volume
    summary: |
      Removes all resources created by extvolume:up:
        - Snowflake external volume
        - IAM role/policy  
        - S3 bucket (with all contents)

      Environment variables (can be set in .env):
        BUCKET: S3 bucket base name (default: iceberg-demo)

      Example:
        task extvolume:down
        task extvolume:down BUCKET=my-data
    cmds:
      - task: extvolume:delete
    env:
      BUCKET: '{{.BUCKET | default "iceberg-demo"}}'
    vars:
      CLI_ARGS: "--delete-bucket --force"

  # ===========================================================================
  # Snowflake CLI Shortcuts
  # ===========================================================================

  snow:test:
    desc: Test Snowflake connection
    cmds:
      - snow connection test

  snow:sql:
    desc: Run SQL query (use -- to pass query)
    summary: |
      Run a SQL query against Snowflake.

      Example:
        task snow:sql -- "SELECT CURRENT_TIMESTAMP()"
        task snow:sql -- "SHOW EXTERNAL VOLUMES"
    cmds:
      - snow sql --query "{{.CLI_ARGS}}"

  snow:volumes:
    desc: List all external volumes
    cmds:
      - snow sql --query "SHOW EXTERNAL VOLUMES"

  snow:pats:
    desc: List programmatic access tokens (optionally for a specific user)
    cmds:
      - |
        if [ -n "{{.PAT_USER}}" ]; then
          snow sql --query "SHOW USER PATS FOR USER {{.PAT_USER}}" --format=json
        else
          snow sql --query "SHOW USER PATS" --format=json
        fi
    vars:
      PAT_USER: '{{.PAT_USER | default ""}}'

  # ===========================================================================
  # AWS CLI Shortcuts
  # ===========================================================================

  aws:whoami:
    desc: Show current AWS identity
    cmds:
      - aws sts get-caller-identity

  aws:buckets:
    desc: List S3 buckets (filtered by prefix, defaults to username)
    summary: |
      Lists S3 buckets filtered by a prefix.

      By default, filters by your username ($(whoami)).

      Example:
        task aws:buckets                    # filter by username
        task aws:buckets PREFIX=myproject   # filter by custom prefix
    cmds:
      - |
        prefix="${PREFIX:-$(whoami)}"
        aws s3 ls | grep "$prefix" || echo "No buckets with prefix '$prefix' found"
    env:
      PREFIX: "{{.PREFIX}}"
    vars:
      PREFIX: '{{.PREFIX | default ""}}'

  aws:roles:
    desc: List IAM roles (filtered by prefix, defaults to username)
    summary: |
      Lists IAM roles filtered by a prefix.

      By default, filters by your username ($(whoami)).

      Example:
        task aws:roles                    # filter by username
        task aws:roles PREFIX=myproject   # filter by custom prefix
    cmds:
      - |
        prefix="${PREFIX:-$(whoami)}"
        aws iam list-roles --query "Roles[?contains(RoleName, '$prefix')].{Name:RoleName,Arn:Arn}" --output table
    env:
      PREFIX: "{{.PREFIX}}"
    vars:
      PREFIX: '{{.PREFIX | default ""}}'

  # ===========================================================================
  # Help Tasks
  # ===========================================================================

  help:
    desc: Show usage guide and quick start
    summary: |
      Snowflake External Volume & PAT Manager
      ════════════════════════════════════════

      QUICK START:
        task extvolume:up                  Create external volume (defaults)
        task extvolume:down                Tear down everything

      DETAILED HELP:
        task <task-name> --summary         Show detailed help for any task
        task --list-all                    List all available tasks

      NAMING CONVENTION:
        Resources are prefixed with your username by default.
        Use --no-prefix to disable, --prefix NAME for custom prefix.

      EXAMPLES:
        task extvolume:up                           # Quick start
        task extvolume:create BUCKET=data           # Custom bucket
        task extvolume:create --summary             # Show detailed help
    cmds:
      - task --summary help

  help:naming:
    desc: Explain prefix and naming conventions
    summary: |
      Naming Conventions
      ══════════════════

      Resources are PREFIXED with your username to avoid conflicts in shared AWS accounts.

      EXAMPLE with BUCKET=iceberg-demo (user: ksampath):

        AWS Resources (lowercase, hyphens):
          Bucket:         ksampath-iceberg-demo
          IAM Role:       ksampath-iceberg-demo-snowflake-role
          IAM Policy:     ksampath-iceberg-demo-snowflake-policy

        Snowflake Objects (UPPERCASE, underscores):
          External Volume: KSAMPATH_ICEBERG_DEMO_EXTERNAL_VOLUME
          External ID:     KSAMPATH_ICEBERG_DEMO_EXTERNAL_ID

      PREFIX OPTIONS:
        (default)         Your username is used as prefix
        --prefix NAME     Use custom prefix
        --no-prefix       No prefix (bucket name as-is)

      EXAMPLES:
        task extvolume:create BUCKET=data                    # → {user}-data
        task extvolume:create BUCKET=data -- --no-prefix     # → data
        task extvolume:create BUCKET=data -- --prefix proj   # → proj-data
    cmds:
      - task --summary help:naming

  help:extvolume:
    desc: Show extvolume CLI options
    cmds:
      - "{{.EXTVOLUME_CLI}} --help"
      - "{{.EXTVOLUME_CLI}} create --help"

  help:pat:
    desc: Show pat CLI options
    cmds:
      - "{{.PAT_CLI}} --help"

  help:networks:
    desc: Show network CLI options
    cmds:
      - "{{.NETWORK_CLI}} --help"

  # ===========================================================================
  # Snow-Utils Setup
  # ===========================================================================

  snow-utils:check:
    desc: Check if snow-utils infrastructure is ready
    summary: |
      Verifies that SA_ROLE and SNOW_UTILS_DB exist.
      
      If infrastructure is missing, offers to run setup (requires ACCOUNTADMIN).
      
      Environment variables (from .env):
        SA_ROLE: SA role name to check (default: SA_ROLE)
        SNOW_UTILS_DB: Database name to check (default: SNOW_UTILS)

      Example:
        task snow-utils:check                    # Check with defaults
        task snow-utils:check -- --quiet        # Silent check (exit code only)
        task snow-utils:check -- --auto-setup   # Auto-run setup if needed
    cmds:
      - "{{.PYTHON}} {{.TASKFILE_DIR}}/check_setup.py {{.CLI_ARGS}}"

  snow-utils:setup:
    desc: Create SA role and SNOW_UTILS database with required privileges
    summary: |
      Creates the SA role and SNOW_UTILS database for snow-utils operations.

      This script must be run by ACCOUNTADMIN or equivalent. The created role
      has scoped-down privileges with NO grant delegation for security.

      Environment variables (from .env, can be overridden):
        SA_ROLE: Name of the SA role to create
        SNOW_UTILS_DB: Name of the database to create

      Created resources:
        - Role: {SA_ROLE} with minimal required privileges
        - Database: {SNOW_UTILS_DB}
        - Schemas: {SNOW_UTILS_DB}.NETWORKS, {SNOW_UTILS_DB}.POLICIES

      Example:
        task snow-utils:setup                                            # Uses .env values
        task snow-utils:setup SA_ROLE=MY_SA_ROLE                        # Override role
        task snow-utils:setup SA_ROLE=MY_SA SNOW_UTILS_DB=MY_UTILS    # Override both
    cmds:
      - echo "Creating SA role ${SA_ROLE} and ${SNOW_UTILS_DB} database..."
      - snow sql -f "{{.TASKFILE_DIR}}/snow-utils-setup.sql" --templating=all
      - echo ""
      - echo "✓ Setup complete!"
      - echo ""
      - echo "Next steps:"
      - echo "  1. Grant the role to users:"
      - echo "     snow sql -q \"GRANT ROLE ${SA_ROLE} TO USER your_username\""
      - echo ""
      - echo "  2. Set environment variables:"
      - echo "     export SNOWFLAKE_ROLE=${SA_ROLE}"
      - echo "     export SNOW_UTILS_DB=${SNOW_UTILS_DB}"
      - echo ""
      - echo "  3. Run snow-utils tasks:"
      - echo "     task pat:create SA_USER=my_sa SA_ROLE=app_role"

  # ===========================================================================
  # Skills Sync Tasks
  # ===========================================================================

  skills:sync:
    desc: Sync CLI scripts to snow-utils-skills repo
    vars:
      SKILLS_REPO: '{{.SKILLS_REPO | default (printf "%s/git/kameshsampath/snow-utils-skills" .HOME)}}'
    preconditions:
      - sh: test -d "{{.SKILLS_REPO}}"
        msg: "Skills repo not found at {{.SKILLS_REPO}}. Set SKILLS_REPO env var."
    cmds:
      - echo "Syncing scripts to {{.SKILLS_REPO}}..."
      - cp extvolume.py "{{.SKILLS_REPO}}/snow-utils-volumes/scripts/"
      - cp snow_common.py "{{.SKILLS_REPO}}/snow-utils-volumes/scripts/"
      - cp check_setup.py "{{.SKILLS_REPO}}/snow-utils-volumes/scripts/"
      - cp snow-utils-setup.sql "{{.SKILLS_REPO}}/snow-utils-volumes/scripts/"
      - cp pat.py "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp snow_common.py "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp network.py "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp network_presets.py "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp check_setup.py "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp snow-utils-setup.sql "{{.SKILLS_REPO}}/snow-utils-pat/scripts/"
      - cp network.py "{{.SKILLS_REPO}}/snow-utils-networks/scripts/"
      - cp network_presets.py "{{.SKILLS_REPO}}/snow-utils-networks/scripts/"
      - cp snow_common.py "{{.SKILLS_REPO}}/snow-utils-networks/scripts/"
      - cp check_setup.py "{{.SKILLS_REPO}}/snow-utils-networks/scripts/"
      - cp snow-utils-setup.sql "{{.SKILLS_REPO}}/snow-utils-networks/scripts/"
      - echo "✓ Scripts synced"
      - echo ""
      - echo "Next steps:"
      - echo "  cd {{.SKILLS_REPO}}"
      - echo "  git diff && git add -A && git commit -m 'Sync scripts' && git push"
      - echo ""
      - 'echo "To reload skills: task skills:reload"'

  skills:reload:
    desc: Sync scripts and reload Cortex Code skills
    vars:
      SKILLS_REPO: '{{.SKILLS_REPO | default (printf "%s/git/kameshsampath/snow-utils-skills" .HOME)}}'
      CORTEX_CONFIG: '{{.CORTEX_CONFIG | default (printf "%s/.config/.snowflake/cortex" .HOME)}}'
    deps:
      - skills:sync
    cmds:
      - echo "Clearing CoCo cache..."
      - rm -rf "{{.CORTEX_CONFIG}}/cache" 2>/dev/null || true
      - echo "✓ Cache cleared"
      - echo "Reloading skills..."
      - cortex skill remove "{{.SKILLS_REPO}}/snow-utils-volumes" 2>/dev/null || true
      - cortex skill remove "{{.SKILLS_REPO}}/snow-utils-pat" 2>/dev/null || true
      - cortex skill remove "{{.SKILLS_REPO}}/snow-utils-networks" 2>/dev/null || true
      - cortex skill add "{{.SKILLS_REPO}}/snow-utils-volumes"
      - cortex skill add "{{.SKILLS_REPO}}/snow-utils-pat"
      - cortex skill add "{{.SKILLS_REPO}}/snow-utils-networks"
      - echo "✓ Skills reloaded"
      - echo ""
      - echo "⚠ Restart CoCo or start a new chat session for changes to take effect"
